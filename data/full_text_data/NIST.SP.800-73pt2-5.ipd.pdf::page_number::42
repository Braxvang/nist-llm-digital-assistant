      NIST SP 800-73pt2-5 ipd (Initial Public Draft)                                          Interfaces for Personal Identity Verification: Part 2
      September 2023                                                                             PIV Card Application Card Command Interface

906   Padding. Prior to encryption, 1 – 16 bytes of padding data SHALL be appended to the PIV data.
907   The padding SHALL be '80' followed by the number of zeros needed to make the total length of
908   the message to be encrypted (i.e., PIV data plus padding) a multiple of 16 bytes. The first byte of
909   the value field of tag '87' — the padding content indicator byte — SHALL be '01' to indicate that
910   padding has been applied.
911   As illustrated in Fig. 1, the input and output of encryption is as follows:
912           •     Encryption input:
913                 Plain Text
914           •     Encryption output:
915                 BER-TLV-encoded encrypted message, which consists of tag '87' followed by the length
916                 of the encoded encrypted message (L cc + 1), the padding indicator byte ('01'), and then
917                 the encrypted data. L cc is the length of the encrypted PIV data; it SHALL be a multiple of
918                 16.

919   4.2.3. Command Integrity
920   The Command MAC (C-MAC) SHALL be generated by applying the cipher-based MAC
921   (CMAC) [SP800-38B] to the header and data field of a command using the SK MAC session key.
922   If fragmentation is required for data transmission, the command SHALL be constructed without
923   fragmentation for the purposes of computing the MAC, and the CLA byte used in the
924   computation of the MAC SHALL be '0C'.
925   The data to be MACed, M C-MAC , SHALL be constructed by concatenating the following:
926           1. The 16-byte MAC chaining value (MCV). For the first command sent after successful
927              completion of the key establishment protocol the MCV consists of 16 bytes of '00'. For
928              each subsequent command the MCV is the 16-byte MAC value computed for the
929              previous command.
930           2. A 16-btye encoded header. The encoded header SHALL consist of the CLA byte ('0C'),
931              the INS byte, P1, and P2, followed by twelve bytes of padding, consisting of '80'
932              followed eleven bytes of '00'. (The length of the data field, L c , is not included in the data
933              to be MACed.)
934           3. The data field, which is the BER-TLV-encoded encrypted message. 18
935           4. L e encapsulated in BER-TLV format with tag '97' if the L e field is included in the
936              command. 19
937   Let T C-MAC = CMAC(SK MAC , M C-MAC ), as described in [SP800-38B]. The BER-TLV-encoded C-
938   MAC for the command SHALL be the 8 most significant bytes of T C-MAC encapsulated in BER-
939   TLV format with tag '8E'. The entire 16-byte value T C-MAC will be the MCV for the next
940   command.
941   Figure 2 illustrates how the C-MAC is generated for each command.


      18
           The data field may be absent in the case of the VERIFY command.
      19
           As noted in Sections 3.1.2 and 3.2.4, the value of Le will always be '00' when it is present.



                                                                                  32
