Special Publication 800-73-4                                          Interfaces for Personal Identity Verification – Part 2:
                                                                      PIV Card Application Card Command Interface

As illustrated in Figure 1, the input and output of encryption is as follows:

          •    Encryption input:
                  Plain Text
          •    Encryption output:
                  BER-TLV encoded encrypted message, which consists of tag '87' followed by the length
                  of the encoded encrypted message (L cc + 1), the padding indicator byte ('01'), and then
                  the encrypted data. L cc is the length of the encrypted PIV data; it shall be a multiple of
                  16.

  4.2.3       Command Integrity

The Command MAC (C-MAC) shall be generated by applying the cipher-based MAC (CMAC)
[SP800-38B] to the header and data field of a command using the SK MAC session key. In the case that
fragmentation is required for data transmission, the command shall be constructed without fragmentation
for the purposes of computing the MAC, and the CLA byte used in the computation of the MAC shall be
'0C'.

The data to be MACed, M C-MAC , shall be constructed by concatenating the following:

     1. The 16-byte MAC chaining value (MCV). For the first command sent after successful completion
        of the key establishment protocol the MCV consists of 16 bytes of '00'. For each subsequent
        command the MCV is the 16-byte MAC value computed for the previous command.

     2. A 16-btye encoded header. The encoded header shall consist of the CLA byte ('0C'), the INS byte,
        P1, and P2, followed by twelve bytes of padding, consisting of '80' followed eleven bytes of '00'.
        (The length of the data field, L c , is not included in the data to be MACed.)

     3. The data field, which is the BER-TLV encoded encrypted message. 18

     4. L e encapsulated in BER-TLV format with tag '97', if the L e field is included in the command. 19

Let T C-MAC = CMAC(SK MAC , M C-MAC ) as described in [SP800-38B]. The BER-TLV encoded C-MAC for
the command shall be the 8 most significant bytes of T C-MAC encapsulated in BER-TLV format with tag
'8E'. The entire 16-byte value T C-MAC will be the MCV for the next command.

Figure 2 below illustrates how the C-MAC is generated for each command.




18 The data field may be absent in the case of the VERIFY command.
19 As noted in Sections 3.1.2 and 3.2.4, the value of L
                                                          e will always be '00', when it is present.




                                                                    33
