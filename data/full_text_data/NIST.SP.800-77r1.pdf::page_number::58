                                                                                              NIST SP 800-77 REV. 1                                                                  GUIDE TO IPSEC VPNS


                                                                                                       the payload is usually a transport layer protocol, often TCP (protocol number 6) or UDP
                                                                                                       (protocol number 17). Every ESP trailer contains a Next Header value.
                                                                                                 â€¢     ICV. This is used to verify the integrity of the encrypted data. For AES-GCM and AES-
                                                                                                       Counter with CBC-MAC (AES-CCM), it consists of an 8, 12, or 16-byte ICV consisting
                                                                                                       solely of the Authentication Tag. For AES CCM, the ICV is encrypted. For AES-GCM
                                                                                                       and AES-CCM, the 16-byte ICV value is recommended by NIST and RFC 8247 [25].
                                                                                                       The recipient of the packet can recalculate the ICV value to confirm that the portions of
                                                                                                       the packet other than the outermost IP header have not been altered in transit.

                                                                                                                                                 Security Parameters Index (SPI)
This publication is available free of charge from: https://doi.org/10.6028/NIST.SP.800-77r1




                                                                                                      ESP Header
                                                                                                                                                 Sequence Number
                                                                                                                                                 Initialization Vector (optional)



                                                                                                                                                 Data (variable)
                                                                                                       Payload


                                                                                                                                                 TFC Padding (optional, variable)

                                                                                                                                                 Padding (0-255 bytes)
                                                                                                      ESP Trailer
                                                                                                                                                                   Padding Length        Next Header


                                                                                                Authentication Data                         Integrity Check Value (ICV) (variable)


                                                                                                                                    Figure 9: ESP Packet Fields

                                                                                              4.1.6    How ESP Works

                                                                                              Reviewing and analyzing actual ESP packets can provide a better understanding of how ESP
                                                                                              works. Figure 10 shows the bytes that compose an actual ESP packet and their American
                                                                                              Standard Code for Information Interchange (ASCII) representations. The ESP packet only
                                                                                              contains four sections (ignoring the link layer): IP header, ESP header, encrypted data (payload
                                                                                              and ESP trailer), and (optionally) authentication data information. It is not possible to determine
                                                                                              if this packet was generated in transport mode or tunnel mode by examining the encrypted data.
                                                                                              However, because the IP header is unencrypted, the IP protocol field in the header does reveal
                                                                                              which IPsec protocol the payload uses (in this case, ESP). As shown in Figure 7 and Figure 8,
                                                                                              the unencrypted fields in both modes (tunnel and transport) are the same.




                                                                                                                                                41
