Special Publication 800-73-4                          Interfaces for Personal Identity Verification â€“ Part 2:
                                                      PIV Card Application Card Command Interface




                               Figure 3. Single Command under Secure Messaging
If the secure messaging data field to be transported is larger than 255 bytes, command chaining will be
needed. Figure 4 shows the APDUs for secure messaging for a case in which the length of the secure
messaging data field is between 256 and 510 bytes, requiring the data to be fragmented across two
APDUs. The APDUs are constructed in the same manner as when fragmentation is not required, except
that the CLA byte for the first APDU is '1C', the first APDU contains the first 255 bytes of the secure
messaging data field, and the second APDU contains the remaining bytes of the secure messaging data
field and the new L e field ('00'). The PIV Card Application provides a two-byte response of '90 00' for the
first APDU. After receiving the second APDU the PIV Card Application reconstructs and processes the
entire command.




                           Figure 4. Chained Command under Secure Messaging

  4.2.5 Response Integrity

The Response MAC (R-MAC) shall be generated by applying CMAC [SP800-38B] to the data field and
status bytes of the response using the SK RMAC session key. An R-MAC shall be generated for each
response that corresponds to a command that was sent to the card using secure messaging.

The data to be MACed, M R-MAC , shall be constructed by concatenating the following:

    1. The 16-byte MAC chaining value (MCV). For the first response sent after successful completion
       of the key establishment protocol the MCV consists of 16 bytes of '00'. For each subsequent
       response the MCV is the 16-byte MAC value computed for the previous response.

    2. The data field (if present), which is the BER-TLV encoded encrypted message.
    3. The status word, SW1 and SW2, encapsulated in BER-TLV format with tag '99'.
Let T R-MAC = CMAC(SK RMAC , M R-MAC ) as described in [SP800-38B]. The BER-TLV encoded R-MAC for
the response shall be the 8 most significant bytes of T R-MAC encapsulated in BER-TLV format with tag
'8E'. The entire 16-byte value T R-MAC will be the MCV for the next response.

Figure 5 below illustrates how the R-MAC is generated for the response.



                                                     35
