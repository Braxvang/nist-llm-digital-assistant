                                                                                              NIST SP 800-77 REV. 1                                                               GUIDE TO IPSEC VPNS


                                                                                                    8. Meanwhile, Gateway B has also installed the IPsec SAs along with the SPD rules.
                                                                                                    9. Gateway B receives the packet and uses the value in the unencrypted SPI field from the
                                                                                                       ESP header to determine which SA should be applied to the packet. After looking up the
                                                                                                       SA parameters (including the secret key(s) needed for integrity protection and
                                                                                                       decryption), gateway B decrypts and validates the packet. This includes removing the
                                                                                                       additional IP packet header, checking the integrity of the encrypted data, optionally
                                                                                                       performing a replay check, and decrypting the original payload. Gateway B checks the
                                                                                                       SPD entry associated with the SAD entry to ensure that the decrypted IP packet complies
                                                                                                       with any source or destination restrictions then sends the packet to its actual destination,
                                                                                                       endpoint B.
This publication is available free of charge from: https://doi.org/10.6028/NIST.SP.800-77r1




                                                                                              If endpoint B wishes to reply to the packet, steps 6 to 9 of this process are repeated, except the
                                                                                              parties are switched. Endpoint B would send a packet to endpoint A; routing would direct it to
                                                                                              gateway B. Gateway B would modify the packet appropriately and send it to gateway A.
                                                                                              Gateway A would process and validate the packet to restore the original IP address, then send the
                                                                                              packet to endpoint A.

                                                                                              Assuming that the IPsec connection between the gateways is sustained, eventually the IKE or
                                                                                              IPsec SAs will approach one of the SA lifetime thresholds (maximum time or maximum bytes
                                                                                              transmitted) as determined by the local policy on the respective gateways. The gateway with the
                                                                                              shortest lifetime first determines whether the maximum SA lifetime is approaching and initiates
                                                                                              the rekeying process using the existing IKE SA. If the IPsec SA is being rekeyed, both ends
                                                                                              install the new inbound and outbound IPsec SA before removing the old inbound and outbound
                                                                                              IPsec SA. Once valid encrypted traffic is received on the new inbound IPsec SA, the old inbound
                                                                                              IPsec SA will be deleted. This ensures that there is no interruption of the traffic flow during
                                                                                              IPsec SA rekeying. If the IKE SA is being rekeyed, both ends replace the IKE SA, and all IPsec
                                                                                              SAs belonging to the old IKE SA are attached to the new IKE SA.

                                                                                              5.3       Procurement Considerations for IPsec Products

                                                                                              IPsec VPN products vary in functionality, including protocol and algorithm support. They also
                                                                                              vary in breadth, depth, and completeness of features and security services. Management features,
                                                                                              such as status reporting, logging, and auditing, should provide adequate capabilities for the
                                                                                              organization to effectively operate and manage the IPsec VPN and extract detailed usage
                                                                                              information. In the case of mesh encryption, too much logging can also be a concern.
                                                                                              Traditionally, the management of IPsec products from different vendors has been problematic.
                                                                                              Some recommendations and considerations include the following:
                                                                                                    •    Ensure that the cryptographic and networking capacity can accommodate the expected
                                                                                                         number of hosts and throughput.
                                                                                                    •    The Simple Network Management Protocol (SNMP) only provides a rudimentary and
                                                                                                         outdated interface for IKE and IPsec management. The IETF is working on a replacement
                                                                                                         management protocol using the YANG [56] data model language with ZEROCONF, 44


                                                                                              44    A history and summary of ZEROCONF can be found at http://www.zeroconf.org/.



                                                                                                                                                         53
