      NIST SP 800-73pt2-5 ipd (Initial Public Draft)            Interfaces for Personal Identity Verification: Part 2
      September 2023                                               PIV Card Application Card Command Interface

953   Figure 3 shows the APDU for secure messaging when command chaining is not required. The
954   APDU consists of the CLA byte ('0C'), INS, P1, P2, the length of the secure messaging data field
955   (L c '), the secure messaging data field, and the new L e field ('00').




956
957                                 Fig. 3. Single command under secure messaging

958   Command chaining will be needed if the secure messaging data field to be transported is larger
959   than 255 bytes. Figure 4 shows the APDUs for secure messaging when the length of the secure
960   messaging data field is between 256 and 510 bytes, which requires the data to be fragmented
961   across two APDUs. The APDUs are constructed in the same manner as when fragmentation is
962   not required, except that the CLA byte for the first APDU is '1C', the first APDU contains the
963   first 255 bytes of the secure messaging data field, and the second APDU contains the remaining
964   bytes of the secure messaging data field and the new L e field ('00'). The PIV Card Application
965   provides a 2-byte response of '90 00' for the first APDU. After receiving the second APDU, the
966   PIV Card Application reconstructs and processes the entire command.




967
968                                Fig. 4. Chained command under secure messaging


969   4.2.5. Response Integrity
970   The response MAC (R-MAC) SHALL be generated by applying CMAC [SP800-38B] to the data
971   field and status bytes of the response using the SK RMAC session key. An R-MAC SHALL be
972   generated for each response that corresponds to a command that was sent to the card using secure
973   messaging.
974   The data to be MACed, M R-MAC , SHALL be constructed by concatenating the following:
975       1. The 16-byte MAC chaining value (MCV). For the first response sent after successful
976          completion of the key establishment protocol the MCV consists of 16 bytes of '00'. For
977          each subsequent response the MCV is the 16-byte MAC value computed for the previous
978          response.
979       2. The data field (if present), which is the BER-TLV-encoded encrypted message



                                                         34
